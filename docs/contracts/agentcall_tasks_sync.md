# Контракт CLI: `agentcall tasks sync`

> Цель: синхронизировать локальный борт `data/tasks.board.json` с внешним провайдером задач, фиксируя план действий (create/update/close) и публикуя структурированный отчёт для аналитики миссии.

## 1. Вызов команд
```
agentcall tasks sync [PATH] \
  [--provider file] \
  [--input /path/to/tasks.json] \
  [--dry-run] \
  [--json]
```

- `PATH` — корень проекта (по умолчанию текущий каталог).
- `--provider` — идентификатор провайдера (пока доступен `file`).
- `--input` — входные данные провайдера (для `file` — путь к JSON снимку).
- `--dry-run` — формирует план действий без применения.
- `--json` — печатает отчёт в stdout.

Команда всегда завершает работу кодом 0, если синхронизация успешно рассчитана, и 1 при ошибках ввода/вывода или некорректной конфигурации.

## 2. Конфигурация провайдера
Пока доступен адаптер `file`, которому требуется JSON-файл со списком задач.

## 3. Структура отчёта
Отчёт записывается в JSON (UTF-8, `ensure_ascii=False`).

```json
{
  "generated_at": "2025-10-07T14:15:22Z",
  "summary": {
    "total": 3,
    "create": 1,
    "update": 1,
    "close": 1
  },
  "operations": [
    {
      "type": "create",
      "task_id": "OPS-010",
      "payload": {
        "id": "OPS-010",
        "title": "Provision SLA webhooks",
        "status": "open"
      }
    },
    {
      "type": "update",
      "task_id": "P7-002",
      "payload": {
        "status": "done"
      }
    },
    {
      "type": "close",
      "task_id": "ARCH-003",
      "payload": {
        "status": "done"
      }
    }
  ]
}
```

## 4. Приоритет полей в диффе
- Обязательные поля: `id`, `title`, `status`.
- Дополнительные поля (`priority`, `owner`, `epic`, `metrics`, `comments`) сравниваются, если присутствуют у провайдера.
- Поля, отсутствующие у провайдера, сохраняются без изменений в локальном борде.

## 5. Поведение применения (`--apply`)
- `create` — задача добавляется в конец массива `tasks` в `data/tasks.board.json` (с объединением дополнительных полей из провайдера, если они заданы).
- `update` — изменяются только поля, указанные в `changes`.
- `close` — если задача существует, её `status` выставляется в `done`, поле `completed_at` обновляется ISO8601 UTC, а запись переносится в конец списка для истории.
- После применения файл перезаписывается канонически (`json.dumps(..., indent=2, sort_keys=False) + \n`).

## 6. Ошибки
- `tasks.sync.config_not_found` — отсутствует конфигурация провайдера.
- `tasks.sync.provider_not_supported` — `type` неизвестен.
- `tasks.sync.input_invalid` — provider JSON невалидный либо отсутствует `id`.
- `tasks.sync.board_invalid` — локальный борт невозможно прочитать/проанализировать.

Ошибки логируются в stderr и код возврата == 1.
